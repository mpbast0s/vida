<!DOCTYPE html>

<html lang="pt_BR">

<head>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>TRABALHO 3: Processador de retas e polígonos</title>
    <link rel="stylesheet" href="./style.css">
    <script type="text/javascript" src="./Canvas.js.download"></script>
    <script type="text/javascript" src="./Linha.js.download"></script>
    <style>
        canvas {
            border: 5px solid rgb(151, 130, 130);
            border-radius: 20px;
            background-color: #c70213;
            background-color: #f5facd;
        }

        body {
            height: 100vh;
            /* Define a altura do corpo como 100% da altura da janela de visualização */
            display: flex;
            /* Usa o modelo de layout flexível */
            justify-content: center;
            /* Centraliza o conteúdo horizontalmente */
            align-items: center;
            /* Centraliza o conteúdo verticalmente */
            text-align: center;
            /* Centraliza o texto */
            position: relative;
            background-color: #f0f0f0;
            /* Mantém a posição relativa para posicionamento de elementos filhos */
        }


        #customers {
            width: 600px;
            margin: auto;
            /* Para centralizar a tabela */
        }

        #customers td {
            width: 25%;
            /* Definindo a largura das células da tabela */
        }

        #sidesInput {
            width: 80%;
            align-self: right;
        }
    </style>

</head>

<body>

    <h1 style="text-align: right;"> Processador de retas e polígonos </h1>
    <br>
    <p> Descrição <a href="https://github.com/mpbast0s/vida/blob/main/README.md"> <s> Clique aqui </s></a></p>

    <div id="canvasDiv">
        <canvas id="canvas" width="500" height="400" style="cursor: pointer;"></canvas>
        <form style="margin-top: 20px;">
            <div class="row align-items-center">
                <table id="customers">
                    <tr>


                        <div>

                            <td><select class="form-select" id="sidesInput">

                                    <option value="3" selected>3 lados</option>
                                    <option value="4">4 lados</option>
                                    <option value="5">5 lados</option>
                                    <option value="6">6 lados</option>
                                    <option value="7">7 lados</option>
                                    <option value="8">8 lados</option>

                                </select>

                            </td>
                        </div>
                        <td>
                            <div class="col-auto">
                                <button type="button" id="botaoCriar" class="btn btn-primary">Criar Polígono</button>
                            </div>
                        </td>
                        <td>
                            <div class="row justify-content-center align-items-center" style="margin-top: 0px;">
                                <div class="col-auto">
                                    <button type="button" class="btn btn-danger" id="cleanButton">Apagar Linhas</button>
                                </div>
                            </div>
                        </td>
                        <td>
                            <input type="color" id="colorPicker" value="#c70213">
                        </td>

            </div>

            </tr>
            </table>
            <br>
            

        </form>
        <script type="text/javascript">
            // Adiciona um ouvinte de evento para detectar alterações no color picker
            let COR_PADRAO = '#c70213';
            const colorPicker = document.getElementById("colorPicker");
            colorPicker.addEventListener("change", function () {
                COR_PADRAO = colorPicker.value; 
                //linhaCor = colorPicker.value; // Atualiza a cor da linha para a cor selecionada no color picker
            });


            // características das linhas: 
            //cores padrões:
            const COR_SELECAO = '#000';
            //const COR_PADRAO = '#c70213';
            const CANVAS_E = document.getElementById("canvas");
            const CTX = CANVAS_E.getContext("2d");
            CTX.lineWidth = 6; //tamanho  
            CTX.lineCap = "BUTT"; // formato da ponta
            CTX.strokeStyle = '#c70213';

            //variáveis iniciais - 
            const CANVAS = new Canvas(CANVAS_E, CTX);
            var acao = 0; // 0 => move ponta[0], 1 => move ponta[1], 2 => move linha toda
            var coord_inicial, pos_inicial;
            const linhas_acao = [];

            // cria uma linha inicial 
            //ponto do meio:
            const centerX = canvas.width / 2;
            const centerY = canvas.height / 2;
            CANVAS.criaLinha({ x: centerX - 100, y: centerY }, { x: centerX + 100, y: centerY });

            CANVAS.desenha();


            // ---------------------------- eventos do canvas ----------------------------

            // remover a ação de abrir o menu do navegador no canvas
            CANVAS_E.addEventListener("contextmenu", e => e.preventDefault());
            // captura o movimento do mouse no canvas
            CANVAS_E.addEventListener("mousemove", function (e) {
                if (e.buttons > 2) return; // ação não interessa
                // não possui botão pressionado, então só faz higlight da linha
                if (e.buttons == 0) {
                    CANVAS.atualizaCores(COR_PADRAO);
                    var linha = CANVAS.obtemLinha(e);
                    if (linha != null) {
                        CANVAS_E.style.cursor = "grab";
                        linha.cor = COR_SELECAO;
                    } else {
                        CANVAS_E.style.cursor = "pointer";
                    }
                    CANVAS.desenha();
                    return;
                }


                const coord = { x: e.offsetX, y: e.offsetY };
                // move a primeira ponta da linha para a posição do mouse
                if (acao == 0) {
                    for (const linha of linhas_acao) {
                        linha.atualizaCoords(coord, linha.coords[1]);
                    }
                }
                // move a segunda ponta da linha para a posição do mouse
                if (acao == 1) {
                    for (const linha of linhas_acao) {
                        linha.atualizaCoords(linha.coords[0], coord);
                    }
                }
                // move toda a linha para uma posição relativa à sua inicial
                if (acao == 2) {
                    for (const linha of linhas_acao) {
                        let coord1 = {
                            x: (coord.x - coord_inicial.x) + pos_inicial[0].x,
                            y: (coord.y - coord_inicial.y) + pos_inicial[0].y
                        };
                        let coord2 = {
                            x: (coord.x - coord_inicial.x) + pos_inicial[1].x,
                            y: (coord.y - coord_inicial.y) + pos_inicial[1].y
                        };
                        linha.atualizaCoords(coord1, coord2);
                    }
                }

                CANVAS.desenha();
            });

            // captura a ação de clique
            CANVAS_E.addEventListener("mousedown", function (e) {
                if (e.buttons > 2) return; // ação não interessa

                var linha = CANVAS.obtemLinha(e);
                linhas_acao.length = 0;
                if (!linha) return;

                const coord = { x: e.offsetX, y: e.offsetY };
                linha.cor = COR_SELECAO;
                // clique esquerdo
                if (e.buttons == 1) {
                    CANVAS_E.style.cursor = "grabbing";
                    // seleciona a linha a ser movida e qual tipo de acao
                    acao = linha.canto(coord);
                    if (acao == 2) {
                        coord_inicial = coord;
                        pos_inicial = linha.coords;
                    }
                    linhas_acao.push(linha);
                } else {
                    CANVAS_E.style.cursor = "text";
                    // divide a linha em 2 e "seleciona" ambas para a açõo
                    // de mové-las (até se soltar o clique)
                    const OFFSET_AMOUNT = 2;
                    const coord_des = { x: e.offsetX + OFFSET_AMOUNT, y: e.offsetY + OFFSET_AMOUNT };
                    nova_linha = CANVAS.divideLinha(coord, linha);
                    nova_linha.cor = COR_SELECAO;
                    acao = 0;
                    linhas_acao.push(linha);
                    linhas_acao.push(nova_linha);
                }
            });

            // captura a ação de "soltar" do mouse
            CANVAS_E.addEventListener("mouseup", function (e) {
                // redefine tudo para o "padrão"
                CANVAS_E.style.cursor = "pointer";
                linhas_acao.length = 0;
                acao = -1;
                CANVAS.atualizaCores(COR_PADRAO);
                CANVAS.desenha();
            });


            // ---------------------------- eventos dos botões ----------------------------
            // criar polígonos
            const botaoCriar = document.getElementById("botaoCriar");
            botaoCriar.addEventListener("click", function () {
                const sides = parseInt(document.getElementById("sidesInput").selectedOptions[0].value);
                CANVAS.criarPoligono(sides);
            });

            // apagar polígonos
            const cleanButton = document.getElementById("cleanButton");
            cleanButton.addEventListener("click", function () {
                CANVAS.limpa();
            });

        </script>
</body>

</html>
